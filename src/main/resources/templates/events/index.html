<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/default}"
>
  <head>
    <title>All events</title>
	<link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
  </head>
  <body>
    <div layout:fragment="content" style="padding-bottom:5vh;">
      <h1>All events</h1>

      <!-- Search Form -->
      <form th:action="@{/events}" method="get" class="mb-3">
        <input
          type="text"
          name="search"
          th:value="${search}"
          placeholder="Enter event name to search"
          class="form-control"
        />
        <button type="submit" class="btn btn-primary mt-2">Search</button>
      </form>

      <!-- Create New Event Button (Visible to Organizers) -->
      <div sec:authorize="hasAnyRole('ORGANIZER', 'ADMIN')">
        <a href="/events/new" class="btn btn-secondary">
          <i class="fa-solid fa-arrow-right"></i> Create New Event
        </a>
      </div>

      <!-- Upcoming Events Section -->
	  
      <h2>Upcoming Events</h2>
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th><i class="fa-solid fa-bolt"></i> Event</th>
            <th><i class="fa-solid fa-map-marker-alt"></i> Venue</th>
            <th><i class="fa-solid fa-calendar"></i> Date</th>
            <th><i class="fa-solid fa-clock"></i> Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="e : ${upcomingEvents}">
            <td>
              <a th:href="@{/events/{id}(id=${e.id})}" th:text="${e.name}"
                >My Event</a
              >
            </td>
            <td th:text="${e.venue.name}">Event Venue</td>
            <td th:text="${{e.date}}">Event Date</td>
            <td th:text="${{e.time}}">Event Time</td>
            <td >
              <a
                class="btn btn-primary"
                sec:authorize="hasRole('ATTENDEE')"
                role="button"
              >
                <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                Register
              </a>
              <a
                class="btn btn-primary"
                sec:authorize="hasAnyRole('ORGANIZER', 'ADMIN')"
                role="button"
                th:href="@{/events/update/{id}(id=${e.id})}"
              >
                <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                Update
              </a>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Previous Events Section -->
	  <div th:if="${previousEvents.size() != 0}">
      <h2>Previous Events</h2>
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th><i class="fa-solid fa-bolt"></i> Event</th>
            <th><i class="fa-solid fa-map-marker-alt"></i> Venue</th>
            <th><i class="fa-solid fa-calendar"></i> Date</th>
            <th><i class="fa-solid fa-clock"></i> Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="e : ${previousEvents}">
            <td>
              <a th:href="@{/events/{id}(id=${e.id})}" th:text="${e.name}"
                >My Event</a
              >
            </td>
            <td th:text="${e.venue.name}">Event Venue</td>
            <td th:text="${{e.date}}">Event Date</td>
            <td th:text="${{e.time}}">Event Time</td>
            <td>
              <a
                class="btn btn-primary"
                role="button"
                th:href="@{/events/{id}(id=${e.id})}"
              >
                <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                Details
              </a>
              <a
                class="btn btn-primary"
                sec:authorize="hasRole('ATTENDEE')"
                role="button"
                th:href="@{/events/{id}(id=${e.id})}"
              >
                <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                Register
              </a>
              <a
                class="btn btn-primary"
                sec:authorize="hasAnyRole('ORGANIZER', 'ADMIN')"
                role="button"
                th:href="@{/events/update/{id}(id=${e.id})}"
              >
                <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                Update
              </a>
            </td>
          </tr>
        </tbody>
      </table>
	  </div>
	    <div th:if="${upcomingEvents.size() != 0}" id="map" style="width:100%;height:30vh;">
	  	<script th:inline="javascript">
	  		mapboxgl.accessToken = [[${MAPBOX_API_KEY}]]
	  		const map = new mapboxgl.Map({
	  		       container: 'map',  
	  		});
			
			var markers = [];
			/*[# th:each="event : ${upcomingEvents}"]*/
			markers.push(new mapboxgl.Marker().setLngLat([-2.2356388, 53.4778586]).addTo(map)); // need to change to [[${event.getVenue().getLongitude()}]]
			/*[/]*/
			var bounds = new mapboxgl.LngLatBounds();
			markers.forEach(marker => bounds.extend(marker.getLngLat()));
			map.fitBounds(bounds);
	  	</script>
	    </div>
    </div>
  </body>
</html>
